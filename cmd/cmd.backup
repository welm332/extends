function get_terms(){
    const terms = [];
    const platform = window.requires.platform;
      const shells = JSON.parse(fs.readFileSync(window.requires.dirname+'/../extends/cmd/shells.json', 'utf8'));
      console.log(shells)
      return shells[platform];
}

window.addEventListener('DOMContentLoaded', ()=>{
    palette_commands["open cmd"] = "openCmd()";//`tab=create_tab();loadhtml(document.querySelector(".editor[data-fullpath='"+tab.dataset.fullpath+"']"), "/../extends/webviewer/web.html");tab.querySelector("#tab_name").textContent = "Browser"`;
});
if(palette_commands !== null){
    palette_commands["open cmd"] = "openCmd()";//`tab=create_tab();loadhtml(document.querySelector(".editor[data-fullpath='"+tab.dataset.fullpath+"']"), "/../extends/webviewer/web.html");tab.querySelector("#tab_name").textContent = "Browser"`;
}

async function openCmd(){
    tab=create_tab();
    const inputer_reg = RegExp("[A-Z]:(\\\\|/)\\S*>$");
    console.log(inputer_reg);
    // console.log(inputer_reg.test(data));
    // loadhtml(document.querySelector(".editor[data-fullpath='"+tab.dataset.fullpath+"']"), "/../extends/webviewer/web.html")
    // console.log(get_terms[0])
    window.api.create_process_shell(get_terms()[1], "Cmd");
    loadhtml(document.querySelector(".editor[data-fullpath='"+tab.dataset.fullpath+"']"), "/../extends/cmd/cmd.html")
    tab.querySelector("#tab_name").textContent ="commandPrompt";
    window.api.on("child_process_session::Cmd",(event,value)=>{
        // console.log(value.data);
    // console.log(value.data);
        // try{
            data = window.requires.iconv.decode(value.data, "shiftjis").trim();
            console.log(data)
            console.log(inputer_reg.test(data));
            const line = document.createElement("div");
            line.className = "line";
            line.textContent = data;
            document.querySelector("#cmd_place").appendChild(line);
            for(const i of document.querySelectorAll(".inputer")){
                i.remove();
            }
            if(inputer_reg.test(data) || 1){
                // console.log(data.match(RegExp("[A-Z]:(\\\\|/)\\S*"))[0]);
                // console.log(data.match(RegExp("[A-Z]:(\\\\|/)\\S*"))[0].substring(0,data.lastIndexOf(">")))
                // const dirs = fs.readdirSync(data.match(RegExp("[A-Z]:(\\\\|/)\\S*"))[0].replaceAll(">", ""));
                line.style.display = "inline-block";
                const input = document.createElement("input");
                
                // input.dataset.children = dirs.join("|");
                // input.dataset.index = 0;
                input.style.backgroundColor = "#1e1e1e";//document.querySelector("#cmd_place").style.backgroundColor;
                input.style.color = "white";
                input.style.outline =  "none";
                input.className = "inputer";
                input.onkeydown = async (event)=>{
                    // target = event.target;
                    // const value = target.value;
                    // console.log(value)
                    let value  = event.key;
                    if(event.key === "Enter"){
                        value = "\n";
                    }else if(event.key === "Tab"){
                        value = "\t";
                    }
                    console.log(value);
                    await window.api.child_process_session_stdin(value,"Cmd");
                    return
                    console.log(event.key);
                    if(event.key === "Tab"){
                        const dirs = event.target.dataset.children.split("|");
                        console.log(dirs);
                        const index = Number(event.target.dataset.index);
                        const replace_index  = index === 0 ? dirs.length-1 : index-1;
                        console.log(index);
                        if(event.target.value.indexOf(dirs[replace_index]) !== -1){
                            event.target.value = event.target.value.replace(dirs[replace_index], dirs[index]);
                        }else{
                            event.target.value += dirs[index];
                        }
                        if(Number(event.target.dataset.index) === dirs.length-1){
                            event.target.dataset.index = 0;
                        }else{
                            event.target.dataset.index = Number(event.target.dataset.index)+1
                        }
                        
                        event.preventDefault();
                        return;
                    }
                    if(event.key !== "Enter"){
                        return
                    }
                    // target = event.target;
                    // const value = target.value;
                    
                    // const line = document.createElement("div");
                    // line.className = "line";
                    // line.textContent = value;
                    // document.querySelector("#cmd_place").replaceChild(line, target);
                    // target.remove();
                    // await window.api.child_process_session_stdin(`${value}\n`,"Cmd");
                    
                }
                document.querySelector("#cmd_place").appendChild(input);
                input.focus();
            }
        // }
        // catch{}
        
    })
        
        // default_onchange();
        // line = txt_editor.session.getLine(txt_editor.getCursorPosition().row);
        // console.log(line);
        // await window.api.child_process_session_stdin(`ls\n`,"Cmd");

}